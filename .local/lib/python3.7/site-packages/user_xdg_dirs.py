import os.path
import re
from xdg import BaseDirectory

"""Retrieve current XDG user directories.

Require the pyxdg library."""

__default_xdg_dirs = {
    "DESKTOP": "$HOME/Desktop",
    "DOCUMENTS": "$HOME/Documents",
    "DOWNLOAD": "$HOME/Downloads",
    "MUSIC": "$HOME/Music",
    "PICTURES": "$HOME/Pictures",
    "PUBLICSHARE": "$HOME/Public",
    "TEMPLATES": "$HOME/Templates",
    "VIDEOS": "$HOME/Videos"
}


def __parse_user_dirs_line(line):
    """Parse one user-dirs.dirs line, returning a tuple variable name/directory
    path or none."""
    name = ""
    directory = ""

    matches = re.match(r'^XDG_(\w+)_DIR="\$HOME/(\w*)"$', line)
    if matches:
        name = matches.group(1)
        home = os.path.expanduser('~')
        directory = os.path.join(home, matches.group(2))
        return (name, directory)

    matches = re.match(r'^XDG_(\w+)_DIR="(\w*)"$', line)
    if matches:
        name = matches.group(1)
        directory = os.path.join(matches.group(2))
        return (name, directory)

    return None


def __parse_user_dirs():
    """Parse user-dirs.dirs, returning a dictionary with variable names as key
    and directory path as values.
    An empty directory is returned if no variable was found."""
    config_path = os.path.join(BaseDirectory.xdg_config_home,
                               "user-dirs.dirs")
    config = dict()

    with open(config_path, 'r') as f:
        for line in f:
            tuple = __parse_user_dirs_line(line)
            if tuple:
                config[tuple[0]] = tuple[1]

    return config


def get_dir(xdg_name):
    """Given the xdg_name, get directory from user-dirs.dirs, or the default
    ones."""
    config = __parse_user_dirs()

    if xdg_name in config:
        directory = config[xdg_name]
    elif xdg_name in __default_xdg_dirs:
        directory = os.path.expandvars(__default_xdg_dirs[xdg_name])
    else:
        return None

    return directory


def get_desktop_dir():
    return get_dir("DESKTOP")


def get_documents_dir():
    return get_dir("DOCUMENTS")


def get_download_dir():
    return get_dir("DOWNLOAD")


def get_music_dir():
    return get_dir("MUSIC")


def get_pictures_dir():
    return get_dir("PICTURES")


def get_publicshare_dir():
    return get_dir("PUBLICSHARE")


def get_templates_dir():
    return get_dir("TEMPLATES")


def get_videos_dir():
    return get_dir("VIDEOS")
