#!/usr/bin/env python3


import argparse
from loguru import logger
import os
import subprocess
import sys


def get_local_timezone() -> str:
    completed_process: subprocess.CompletedProcess | None = None

    try:
        completed_process = subprocess.run(
            ["timedatectl", "show", "-P", "Timezone"],
            capture_output=True,
            text=True,
            check=True,
        )
    except subprocess.CalledProcessError:
        logger.critical("failed to run timedatectl")
        sys.exit(1)
    logger.debug(f"{completed_process.args} -> {completed_process.stdout.strip()}")

    local_timezone = completed_process.stdout.strip()
    logger.debug(f"local timezone: {local_timezone!r}")

    return local_timezone


def convert_foreign_date_in_local_date(foreign_date: str, foreign_timezone: str) -> str:
    """Convert the foreign date into the local date.
    The foreign date in the foreign timezone is converted into the equivalent date in the local timezone.
    """
    completed_process: subprocess.CompletedProcess | None = None
    env_with_local_timezone = os.environ.copy()
    env_with_local_timezone["TZ"] = get_local_timezone()

    try:
        completed_process = subprocess.run(
            ["date", "--date", f'TZ="{foreign_timezone}" {foreign_date}'],
            env=env_with_local_timezone,
            capture_output=True,
            text=True,
            check=True,
        )
    except subprocess.CalledProcessError:
        logger.critical(
            f"unknown formatting:\n  foreign_timezone: '{foreign_timezone}'\n  foreign_date: '{foreign_date}'"
        )
        sys.exit(1)

    logger.debug(f"{completed_process.args} -> {completed_process.stdout.strip()}")
    local_date = completed_process.stdout.strip()
    logger.debug(f"local date: {local_date}")

    return local_date


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description="Convert a foreign date into the local date.",
        epilog="""example:
    %(prog)s "13:00 Thursday 11 September" "Europe/Helsinki"

    prints the local time and date, for the next Thursday 11 September at 13:00 Finnish time""",
    )
    parser.add_argument(
        "foreign_date",
        help="date in the foreign timezone, (see 'DATE STRING' section in date's manual)",
    )
    parser.add_argument(
        "foreign_timezone",
        help="timezone of the given date (see 'timedatectl list-timezones')",
    )
    parser.add_argument(
        "-v", "--verbose", action="store_true", help="""increase verbosity"""
    )
    arguments = parser.parse_args()

    logger.remove()
    if arguments.verbose:
        logger.add(sys.stderr, level="DEBUG")
    else:
        logger.add(sys.stderr, level="WARNING")

    print(
        convert_foreign_date_in_local_date(
            arguments.foreign_date, arguments.foreign_timezone
        )
    )
